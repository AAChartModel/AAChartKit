desc 'å‘å¸ƒpodæ–°ç‰ˆæœ¬'
lane :release_pod do |options|
  # å­˜æ”¾ç§æœ‰podspecçš„ä»“åº“å
  target_repo    = options[:repo]

  # éœ€è¦æ›´æ–°çš„é¡¹ç›®åç§°
  target_project = options[:project]

  # éœ€è¦æ›´æ–°çš„ pod ç‰ˆæœ¬
  target_version = options[:version]

  # æœ¬æ¬¡æ›´æ–°çš„æäº¤ä¿¡æ¯
  target_desc    = options[:desc]

  # podspec çš„è·¯å¾„
  spec_path      = "#{target_project}.podspec"

  # å‚æ•°åˆ¤æ–­
  if target_project.nil? || target_project.empty? || target_version.nil? || target_version.empty?
    UI.message("âŒ é¡¹ç›®åç§°ã€æ›´æ–°çš„podç‰ˆæœ¬å¿…é¡»å¡«å†™")
    exit
  end

  # å¼€å§‹å‘å¸ƒ
  UI.message("ğŸ‘‰ å¼€å§‹å‘å¸ƒ #{target_project} æ–°çš„ç‰ˆæœ¬ï¼š #{target_version}")

  # ç¡®è®¤æ˜¯masteråˆ†æ”¯
  ensure_git_branch
  # ä¿®æ”¹ spec ä¸ºå³å°†å‘å¸ƒçš„ç‰ˆæœ¬
  version_bump_podspec(path: spec_path, version_number: target_version)
  # commit ä»£ç 
  git_add(path: '.')
  begin
    if target_desc.nil? || target_desc.empty?
      git_commit(path: '.', message: "release #{target_version}")
    else
      git_commit(path: '.', message: target_desc)
    end
  rescue
    error_message = "#{$!}"
    UI.message("âŒ git commit æŠ¥é”™:#{error_message}")
    unless error_message.include?("nothing to commit, working directory clean")
      exit
    end
    UI.message("æœ¬åœ°ä»£ç å·²ç»commit, è·³è¿‡æ­¤æ¬¡commit")
  end
  # æ‹‰å–æœ€æ–°ä»£ç 
  # git_pull_allow_unrelated_histories
  git_pull(rebase: true) # use --rebase with pull
  # æäº¤ä»£ç åˆ°è¿œç«¯ä»“åº“
  push_to_git_remote
  # åˆ¤æ–­ tag æ˜¯å¦å­˜åœ¨
  if git_tag_exists(tag: target_version)
      UI.message("Tag #{target_version} å·²ç»å­˜åœ¨, æ­£åœ¨åˆ é™¤æ—§çš„tag ğŸ’¥")
      # tag å·²å­˜åœ¨ï¼Œåˆ™åˆ é™¤æ—§çš„tag
      remove_git_tag(tag: target_version)
  end
  # æ·»åŠ æ–°çš„ tag
  add_git_tag(tag: target_version)
  # æäº¤æ–°çš„ tag åˆ°è¿œç«¯ä»“åº“
  push_git_tags
  # éªŒè¯æ­¤æ¬¡æ›´æ–°æ˜¯å¦åˆæ³•
  pod_lib_lint(allow_warnings: true)
  if target_repo
    pod_push(path: spec_path, repo: target_repo, allow_warnings: true)
    # å‘å¸ƒæˆåŠŸ
    UI.message("Release lib #{target_project} new version #{target_version} to #{target_repo}  Successfully! ğŸ‰ ")
  else
    pod_push(path: spec_path, allow_warnings: true)
    # å‘å¸ƒæˆåŠŸ
    UI.message("Release lib #{target_project} new version #{target_version} to CocoaPods/Specs Successfully! ğŸ‰ ")
  end
end
